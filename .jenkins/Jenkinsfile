@Library('pipeline-shared-library@master') _

pipeline {
  agent {
    label 'ec2-agent'
  }
  triggers {
    cron('H 5-17 * * 1-5')
  }
  options {
    gitLabConnection(env.GITLAB_CONNECTION_NAME)
    disableConcurrentBuilds()
    skipDefaultCheckout(true)
    ansiColor('xterm')
  }
  stages {
    stage('Checkout') {
      steps {
        ciCheckout()
        sh './scripts/get-version.sh >.version'
      }
    }
    stage('Build') {
      when {
        not {
          triggeredBy 'TimerTrigger'
        }
      }
      steps {
        withGradle {
          withCredentials(
              [usernamePassword(
                  credentialsId: 'artifactory-user',
                  usernameVariable: 'S8_REPO_USER',
                  passwordVariable: 'S8_REPO_PASSWORD')]) {
            sh './gradlew -Pversion=$(cat .version) clean build'
          }
        }
      }
      post {
        always {
          discoverGitReferenceBuild()
          junit allowEmptyResults: true, testResults: '**/build/test-results/test/TEST-*.xml'
          jacoco()

          recordIssues enabledForFailure: true, tools: [java(), javaDoc()]
          recordIssues enabledForFailure: true, tool: checkStyle(
              pattern: '**/build/reports/checkstyle/main.xml, **/build/reports/checkstyle/test.xml')
          recordIssues enabledForFailure: true, tool: taskScanner(
              includePattern: '**/*.java, **/*.groovy',
              ignoreCase: true,
              highTags: 'HACK',
              normalTags: 'TODO, FIXME',
              lowTags: 'XXX')
        }
      }
    }
    stage('Publish') {
      when {
        not {
          triggeredBy 'TimerTrigger'
        }
      }
      steps {
        withGradle {
          withCredentials(
              [usernamePassword(
                  credentialsId: 'artifactory-user',
                  usernameVariable: 'S8_REPO_USER',
                  passwordVariable: 'S8_REPO_PASSWORD'),
               usernamePassword(
                   credentialsId: 'artifactory-deployment-user',
                   usernameVariable: 'repoDeploymentUser',
                   passwordVariable: 'repoDeploymentPassword')]) {
            withDockerRegistry(
                url: 'https://docker.repo.silenteight.com',
                credentialsId: 'artifactory-deployment-user') {
              sh '''./gradlew \
                -Dsilenteight.repoDeploymentUser=$repoDeploymentUser \
                -Dsilenteight.repoDeploymentPassword=$repoDeploymentPassword \
                -Djib.console=plain \
                -Pversion=$(cat .version) \
                publish
              '''
            }
          }
        }
        updateBuildName displayName: "#${env.BUILD_NUMBER} v${readFile(file: '.version').trim()}"
      }
    }
    stage('Release') {
      parallel {
        stage('Release K8s/Sierra') {
          steps {
            echo 'placeholder deployment'
          }
        }
        stage('Release K8s/Hotel') {
          steps {
            echo 'placeholder deployment'
          }
        }
        stage('Deploy to Nomad') {
          steps {
            echo 'placeholder deployment'
          }
        }
      }
    }
  }
}
