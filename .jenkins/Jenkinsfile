@Library('pipeline-shared-library@master') _

pipeline {
  agent {
    label 'ec2-agent'
  }
  options {
    gitLabConnection(env.GITLAB_CONNECTION_NAME)
    skipDefaultCheckout(true)
    ansiColor('xterm')
  }
  tools {
    jdk 'jdk-17'
  }
  stages {
    stage('Checkout') {
      steps {
        ciCheckout()
      }
    }
    stage('Build') {
      steps {
        withCredentials(
            [usernamePassword(
                credentialsId: 'artifactory-deployment-user',
                usernameVariable: 'repoDeploymentUser',
                passwordVariable: 'repoDeploymentPassword'),
             usernamePassword(
                 credentialsId: 'artifactory-user',
                 usernameVariable: 'S8_REPO_USER',
                 passwordVariable: 'S8_REPO_PASSWORD'),]) {
          withGradle {
            sh '''./gradlew \
              -Dsilenteight.repoDeploymentUser=$repoDeploymentUser \
              -Dsilenteight.repoDeploymentPassword=$repoDeploymentPassword \
              -Djib.console=plain \
              clean build package
            '''
          }
        }
      }
    }
  }
}
