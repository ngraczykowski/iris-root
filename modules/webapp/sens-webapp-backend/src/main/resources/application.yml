####################################################################################################
# Defaults (overridden by environment variables or arguments)
####################################################################################################

sens.webapp.db.host: localhost
sens.webapp.db.port: ${POSTGRES_PORT:24480}
sens.webapp.db.schema: public
sens.webapp.db.name: ${POSTGRES_DB:sens}
sens.webapp.db.user: ${POSTGRES_USER:sens}
sens.webapp.db.password: ${POSTGRES_PASSWORD:sens}
sens.webapp.db.url: jdbc:postgresql://${sens.webapp.db.host}:${sens.webapp.db.port}/${sens.webapp.db.name}?currentSchema=${sens.webapp.db.schema}

sens.webapp.db.connections.min: 1
sens.webapp.db.connections.max: 10

sens.webapp.grpc.timeout: PT7S

sens.chrome-extension.auth-url: ${SENS_CHROME_EXTENSION_AUTH_URL}
sens.chrome-extension.recommendation-url: ${SENS_CHROME_EXTENSION_RECOMMENDATION_URL}
sens.chrome-extension.open-record-url-pattern: ${SENS_CHROME_EXTENSION_OPEN_RECORD_URL_PATTERN}
sens.chrome-extension.solution-url-pattern: ${SENS_CHROME_EXTENSION_SOLUTION_URL_PATTERN}
sens.chrome-extension.hits-url-pattern: ${SENS_CHROME_EXTENSION_HITS_URL_PATTERN}
sens.chrome-extension.log-level: debug
sens.chrome-extension.comment-length-threshold: 1024
sens.chrome-extension.refresh-interval-in-ms: 1000

sens.webapp.rabbitmq.host: localhost
sens.webapp.rabbitmq.port: 24130
sens.webapp.rabbitmq.user: serp
sens.webapp.rabbitmq.password: serp

sens.webapp.messaging.concurrency: 4
sens.webapp.messaging.prefetch: 25

####################################################################################################
info:
  component: "SENS Web App REST API"

spring:
  aop:
    proxy-target-class: true

  jackson.serialization.write_dates_as_timestamps: false

  cache.cache-names:
    - aclCache

  datasource:
    # Postgres database
    type: com.zaxxer.hikari.HikariDataSource
    driver-class-name: org.postgresql.Driver
    url: ${sens.webapp.db.url}
    username: ${sens.webapp.db.user}
    password: ${sens.webapp.db.password}
    initialization-mode: never

    # Hikari pool configuration
    hikari:
      pool-name: Database-Pool
      minimum-idle: ${sens.webapp.db.connections.min}
      maximum-pool-size: ${sens.webapp.db.connections.max}
      auto-commit: false
      schema: ${sens.webapp.db.schema}
      isolate-internal-queries: true
      connection-init-sql: SELECT 1
      data-source-properties:
        ApplicationName: SENS WebApp

  # Database migrations
  liquibase:
    change-log: classpath:db/changelog/db.changelog-master.xml
    default-schema: ${sens.webapp.db.schema}
    contexts: default

  # Spring Data JPA
  jpa:
    database-platform: com.silenteight.sep.base.common.support.hibernate.FixedPostgreSql95Dialect
    database: POSTGRESQL
    show-sql: false
    open-in-view: false

    hibernate:
      ddl-auto: none
      use-new-id-generator-mappings: true

    properties:
      hibernate.cache.use_query_cache: false
      hibernate.connection.provider_disables_autocommit: true
      hibernate.generate_statistics: false
      hibernate.jdbc.lob.non_contextual_creation: true
      hibernate.jdbc.time_zone: UTC
      hibernate.temp.use_jdbc_metadata_defaults: false
      org.hibernate.envers.audit_table_suffix: _audit
      org.hibernate.envers.store_data_at_delete: true

  rabbitmq:
    # virtual-host:
    # addresses: ${serp.rabbitmq.addresses}
    host: ${sens.webapp.rabbitmq.host}
    port: ${sens.webapp.rabbitmq.port}
    username: ${sens.webapp.rabbitmq.user}
    password: ${sens.webapp.rabbitmq.password}
    ssl:
      enabled: true
      key-store: file:${serp.home}/cert/${spring.application.name}/${spring.application.name}-keystore.p12
      key-store-password: ${sens.webapp.keystore.password}
      trust-store: file:${serp.home}/cert/truststore.p12
      trust-store-password: ${sens.webapp.truststore.password}
    listener:
      type: simple
      direct:
        consumers-per-queue: ${sens.webapp.messaging.concurrency}
        prefetch: ${sens.webapp.messaging.prefetch}
      simple:
        concurrency: 1
        max-concurrency: ${sens.webapp.messaging.concurrency}
        prefetch: ${sens.webapp.messaging.prefetch}
  # Spring Integration
  integration:
    start-delay-seconds: 15
    poll-period-millis: 1000

grpc:
  client:
    GLOBAL:
      enableKeepAlive: true
      negotiationType: TLS
      security:
        clientAuthEnabled: true
        certificateChain: file:${serp.home}/cert/user/user-chain.pem
        privateKey: file:${serp.home}/cert/user/user-key-pkcs8.pem
        trustCertCollection: file:${serp.home}/cert/chain.pem

    governance:
      address: discovery:///grpc-governance

    reco:
      address: discovery:///grpc-reco

    circuit-breaker:
      address: discovery:///grpc-circuit-breaker

sens.webapp.messaging:
  bulk-change:
    exchange: bulk-change
    route:
      create: bulk-change.create
      apply: bulk-change.apply
      reject: bulk-change.reject
  change-request:
    exchange: change-request
    route:
      create: change-request.create
      approve: change-request.approve
      reject: change-request.reject
      cancel: change-request.cancel
    queue:
      create: webapp.change-request.create
      approve: webapp.change-request.approve
      reject: webapp.change-request.reject
      cancel: webapp.change-request.cancel
  circuit-breaker.discrepancy:
    exchange: discrepancy
    route:
      archive: discrepancy.archive

sens.webapp.change-request.max-closed: 30

sens:
  grpc:
    timeout: ${sens.webapp.grpc.timeout}

  circuit-breaker:
    limit-archived-discrepant-branches: 10

server:
  port: 24410
  servlet:
    context-path: /rest/${spring.application.name}

# Management HTTP server
management:
  endpoint:
    health.show-details: always

  info.git.mode: full

  endpoints:
    web:
      base-path: /management
      exposure:
        include: ["health", "info", "liquibase", "metrics", "prometheus", "loggers"]

  metrics:
    tags:
      application: ${spring.application.name}

security.basic:
  enabled: false

sens.logging.file:
  dir: logs/
  name: ${spring.application.name}

####################################################################################################
sens.web:
  cors:
    allowed-origins: "*"
    allowed-methods: "*"
    allowed-headers: "*"
    exposed-headers: "Authorization,Link,X-Total-Count"
    allow-credentials: true
    max-age: 1800

  #   # Colors palette for AI Solutions
  #   ## Color code
  #   Colors below are divided into four main groups one for each solution:
  #   - The red color is related to a negative situation. That's why it should be used only for a dangerous alert like "True positive."
  #   - The blue color is neutral and associated with information. That's why it should be used in the case when Analyst must do additional investigation.
  #   - The green color occurs to something positive. That's why it should be used only when the alert is a "False positive," which means it is not a threat.
  #   - Gray is a neutral color which distinguishes itself from red, blue, and green. Therefore, it should be used only in a situation when there is no solution yet.
  #   ## Color variants
  #   For each set use first color to describe the main solution. Use other shades from the particular set for additional   solutions in that group.
  #   ## Colors
  #   ### Negative like "True positive"
  #   ai-solution-negative-1  — Red
  #   ai-solution-negative-2 — Orange
  #   ai-solution-negative-3 — Amber
  #   ### Information like "Further investigation needed"
  #   ai-solution-info-1 — purple
  #   ai-solution-info-2 — Indigo
  #   ai-solution-info-3  — Blue
  #   ### Positive like "False Positive"
  #   ai-solution-positive-1 — Green
  #   ai-solution-positive-2 — Light Green
  #   ai-solution-positive-3 — Teal
  #   ### Neutral like "No Decision"
  #   ai-solution-unset-1 — Gray

  api.frontEnd.decisionsConfiguration:
    - key: "NO_DECISION"
      label: "NO_DECISION"
      className: "ai-solution-unset-1"
    - key: "FALSE_POSITIVE"
      label: "FALSE_POSITIVE"
      className: "ai-solution-positive-1"
    - key: "HINTED_FALSE_POSITIVE"
      label: "HINTED_FALSE_POSITIVE"
      className: "ai-solution-info-1"
    - key: "HINTED_POTENTIAL_TRUE_POSITIVE"
      label: "HINTED_POTENTIAL_TRUE_POSITIVE"
      className: "ai-solution-info-2"
    - key: "POTENTIAL_TRUE_POSITIVE"
      label: "POTENTIAL_TRUE_POSITIVE"
      className: "ai-solution-negative-1"

# Authorization
sep.auth:
  methodPermissionsMappings:
    APPROVE_CHANGE_REQUEST.permissions: [ "APPROVE_CHANGE_REQUESTS" ]
    ARCHIVE_DISCREPANCIES.permissions: [ "ARCHIVE_DISCREPANCIES" ]
    CANCEL_CHANGE_REQUEST.permissions: [ "CANCEL_CHANGE_REQUESTS" ]
    CREATE_BULK_CHANGE.permissions: [ "CREATE_CHANGE_REQUESTS" ]
    CREATE_CHANGE_REQUEST.permissions: [ "CREATE_CHANGE_REQUESTS" ]
    CREATE_USER.permissions: [ "MANAGE_USERS" ]
    EDIT_USER.permissions: [ "MANAGE_USERS" ]
    GENERATE_REPORT.permissions: [ "GENERATE_REPORTS" ]
    GET_CLOSED_BULK_CHANGE_IDS.permissions: [ "VIEW_CHANGE_REQUESTS" ]
    GET_DECISION_TREE.permissions: [ "VIEW_DECISION_TREE" ]
    GET_PENDING_BULK_CHANGE_IDS.permissions: [ "VIEW_BULK_CHANGES" ]
    LIST_CLOSED_BULK_CHANGES.permissions: [ "VIEW_CHANGE_REQUESTS" ]
    LIST_CLOSED_CHANGE_REQUESTS.permissions: [ "VIEW_CHANGE_REQUESTS" ]
    LIST_DISCREPANCIES.permissions: [ "VIEW_DISCREPANCIES" ]
    LIST_DISCREPANT_BRANCH_IDS.permissions: [ "VIEW_DISCREPANCIES" ]
    LIST_DISCREPANT_BRANCHES.permissions: [ "VIEW_DISCREPANCIES" ]
    LIST_FEATURE_NAMES.permissions: [ "VIEW_FEATURES" ]
    LIST_FEATURE_VALUES.permissions: [ "VIEW_FEATURES" ]
    LIST_PENDING_BULK_CHANGES.permissions: [ "VIEW_CHANGE_REQUESTS" ]
    LIST_PENDING_CHANGE_REQUESTS.permissions: [ "VIEW_CHANGE_REQUESTS" ]
    LIST_REASONING_BRANCHES.permissions: [ "VIEW_REASONING_BRANCHES" ]
    LIST_ROLES.permissions: [ "MANAGE_USERS" ]
    LIST_USERS.permissions: [ "MANAGE_USERS" ]
    REJECT_CHANGE_REQUEST.permissions: [ "REJECT_CHANGE_REQUESTS" ]
    RESET_USER_PASSWORD.permissions: [ "MANAGE_USERS" ]
    SYNC_ANALYSTS.permissions: [ "SYNC_ANALYSTS" ]
    VALIDATE_REASONING_BRANCHES.permissions: [ "VALIDATE_REASONING_BRANCHES" ]

  rolePermissionsMappings:
    ADMIN:
      - "GENERATE_REPORTS"
      - "MANAGE_USERS"
      - "SYNC_ANALYSTS"
    APPROVER:
      - "APPROVE_CHANGE_REQUESTS"
      - "GENERATE_REPORTS"
      - "REJECT_CHANGE_REQUESTS"
      - "VIEW_CHANGE_REQUESTS"
      - "VIEW_DECISION_TREE"
      - "VIEW_FEATURES"
      - "VIEW_REASONING_BRANCHES"
    AUDITOR:
      - "GENERATE_REPORTS"
    BUSINESS_OPERATOR:
      - "ARCHIVE_DISCREPANCIES"
      - "CANCEL_CHANGE_REQUESTS"
      - "CREATE_CHANGE_REQUESTS"
      - "GENERATE_REPORTS"
      - "VALIDATE_REASONING_BRANCHES"
      - "VIEW_CHANGE_REQUESTS"
      - "VIEW_DECISION_TREE"
      - "VIEW_DISCREPANCIES"
      - "VIEW_FEATURES"
      - "VIEW_REASONING_BRANCHES"
