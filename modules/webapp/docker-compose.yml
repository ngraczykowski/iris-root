version: "3.5"

services:
  webapp-db:
    image: postgres:10
    restart: unless-stopped
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    environment:
      POSTGRES_DB: "${POSTGRES_DB:-sens}"
      POSTGRES_USER: "${POSTGRES_USER:-sens}"
      POSTGRES_PASSWORD: "${POSTGRES_PASSWORD:-sens}"
      PGDATA: "/var/lib/postgresql/data/pgdata"
    volumes:
      - postgres-storage:/var/lib/postgresql/data
    networks:
      - sens-webapp

  keycloak:
    image: jboss/keycloak:8.0.1
    restart: unless-stopped
    volumes:
      - ./conf/keycloak:/config/
    environment:
      KEYCLOAK_USER: "${KEYCLOAK_ADMIN_USERNAME:-sens}"
      KEYCLOAK_PASSWORD: "${KEYCLOAK_ADMIN_PASSWORD:-sens}"
      DB_ADDR: webapp-db
      DB_VENDOR: postgres
      DB_PORT: 5432
      DB_USER: "${POSTGRES_USER:-sens}"
      DB_PASSWORD: "${POSTGRES_PASSWORD:-sens}"
      DB_DATABASE: "${POSTGRES_DB:-sens}"
    depends_on:
      - webapp-db
    command:
      - "-b 0.0.0.0 -Dkeycloak.profile.feature.upload_scripts=enabled"
    ports:
      - "${KEYCLOAK_PORT:-8081}:8080"
    networks:
      - sens-webapp

  keycloak-saml-idp:
    image: jboss/keycloak:8.0.1
    restart: unless-stopped
    volumes:
      - ./conf/keycloak-saml-idp:/config/
    environment:
      KEYCLOAK_USER: "${EXTERNAL_SAML_ADMIN_USERNAME:-scb}"
      KEYCLOAK_PASSWORD: "${EXTERNAL_SAML_ADMIN_PASSWORD:-scb}"
    command:
      - "-b 0.0.0.0 -Dkeycloak.profile.feature.upload_scripts=enabled -Dkeycloak.migration.action=import -Dkeycloak.migration.provider=singleFile -Dkeycloak.migration.file=/config/saml-realm-realm.json -Dkeycloak.migration.strategy=OVERWRITE_EXISTING"
    ports:
      - "${EXTERNAL_SAML_PORT:-8095}:8080"
    networks:
      - external-premises

volumes:
  postgres-storage:

networks:
  sens-webapp:
    driver: bridge
  external-premises:
    driver: bridge
