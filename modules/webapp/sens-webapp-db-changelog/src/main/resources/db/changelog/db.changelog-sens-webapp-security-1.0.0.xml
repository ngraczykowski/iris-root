<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

  <changeSet id="security-1.0.0-1" author="mmastylo">
    <createTable tableName="acl_sid">
      <column name="id" type="BIGINT" autoIncrement="true">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="principal" type="BOOLEAN">
        <constraints nullable="false"/>
      </column>
      <column name="sid" type="VARCHAR(100)">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <addUniqueConstraint tableName="acl_sid"
                         columnNames="sid,principal"
                         constraintName="uq_acl_sid_sid_principal"/>

    <createTable tableName="acl_class">
      <column name="id" type="BIGINT" autoIncrement="true">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="class" type="VARCHAR(150)">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <addUniqueConstraint tableName="acl_class"
                         columnNames="class"
                         constraintName="uq_acl_class_class"/>

    <createTable tableName="acl_object_identity">
      <column name="id" type="BIGINT" autoIncrement="true">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="object_id_class" type="BIGINT">
        <constraints nullable="false"/>
      </column>
      <column name="object_id_identity" type="VARCHAR(36)">
        <constraints nullable="false"/>
      </column>
      <column name="parent_object" type="BIGINT"/>
      <column name="owner_sid" type="BIGINT"/>
      <column name="entries_inheriting" type="BOOLEAN">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <addUniqueConstraint
        tableName="acl_object_identity"
        columnNames="object_id_class,object_id_identity"
        constraintName="uq_acl_object_identity_object_id_class_object_id_identity"/>

    <addForeignKeyConstraint
        baseTableName="acl_object_identity"
        baseColumnNames="parent_object"
        constraintName="fk_acl_object_identity_parent_object"
        referencedTableName="acl_object_identity"
        referencedColumnNames="id"
        onUpdate="CASCADE"
        onDelete="SET NULL"/>

    <addForeignKeyConstraint
        baseTableName="acl_object_identity"
        baseColumnNames="object_id_class"
        constraintName="fk_acl_object_identity_object_id_class"
        referencedTableName="acl_class"
        referencedColumnNames="id"
        onUpdate="CASCADE"
        onDelete="CASCADE"/>

    <addForeignKeyConstraint
        baseTableName="acl_object_identity"
        baseColumnNames="owner_sid"
        constraintName="fk_acl_object_identity_owner_sid"
        referencedTableName="acl_sid"
        referencedColumnNames="id"
        onUpdate="CASCADE"
        onDelete="SET NULL"/>

    <createTable tableName="acl_entry">
      <column name="id" type="BIGINT" autoIncrement="true">
        <constraints primaryKey="true"/>
      </column>
      <column name="acl_object_identity" type="BIGINT">
        <constraints nullable="false"/>
      </column>
      <column name="ace_order" type="INT">
        <constraints nullable="false"/>
      </column>
      <column name="sid" type="BIGINT">
        <constraints nullable="false"/>
      </column>
      <column name="mask" type="INTEGER">
        <constraints nullable="false"/>
      </column>
      <column name="granting" type="BOOLEAN">
        <constraints nullable="false"/>
      </column>
      <column name="audit_success" type="BOOLEAN">
        <constraints nullable="false"/>
      </column>
      <column name="audit_failure" type="BOOLEAN">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <addUniqueConstraint
        tableName="acl_entry"
        columnNames="acl_object_identity,ace_order"
        constraintName="uq_acl_entry_class_acl_object_identity_ace_order"/>

    <addForeignKeyConstraint
        baseTableName="acl_entry"
        baseColumnNames="acl_object_identity"
        constraintName="fk_acl_entry_acl_object_identity"
        referencedTableName="acl_object_identity"
        referencedColumnNames="id"
        onUpdate="CASCADE"
        onDelete="CASCADE"/>

    <addForeignKeyConstraint
        baseTableName="acl_entry"
        baseColumnNames="sid"
        constraintName="fk_acl_entry_sid"
        referencedTableName="acl_sid"
        referencedColumnNames="id"
        onUpdate="CASCADE"
        onDelete="CASCADE"/>
  </changeSet>

  <changeSet id="security-1.0.0-2" author="mmastylo">
    <addColumn tableName="acl_class">
      <column name="class_id_type" type="VARCHAR(150)"/>
    </addColumn>
  </changeSet>

</databaseChangeLog>
