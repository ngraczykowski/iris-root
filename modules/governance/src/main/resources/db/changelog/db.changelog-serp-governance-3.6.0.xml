<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

  <property name="uuid.type" value="UUID" dbms="postgresql"/>
  <property name="uuid.type" value="BINARY(16)" dbms="mysql,hsqldb"/>

  <changeSet id="serp-governance-3.6.0-1" author="tkleszcz">
    <comment>
      Add feature_vector_signature column.
    </comment>

    <dropView viewName="governance_reasoning_branch_query"/>
    <createView viewName="governance_reasoning_branch_query">
      SELECT dt.decision_tree_id,
             fv.feature_vector_id,
             fv.vector_signature as feature_vector_signature,
             b.solution,
             b.enabled,
             fv."values",
             b.created_at,
             b.last_used_at
      FROM governance_decision_tree dt
               CROSS JOIN governance_feature_vector fv
               LEFT JOIN governance_branch b
                         ON dt.decision_tree_id = b.decision_tree_id
                             AND b.feature_vector_id = fv.feature_vector_id
    </createView>
  </changeSet>

  <changeSet id="serp-governance-3.6.0-2" author="tkleszcz">
    <comment>
      Add updated_at column.
    </comment>

    <dropView viewName="governance_reasoning_branch_query"/>
    <createView viewName="governance_reasoning_branch_query">
      SELECT dt.decision_tree_id,
             fv.feature_vector_id,
             fv.vector_signature as feature_vector_signature,
             b.solution,
             b.enabled,
             fv.values,
             b.created_at,
             b.updated_at,
             b.last_used_at
      FROM governance_decision_tree dt
               CROSS JOIN governance_feature_vector fv
               LEFT JOIN governance_branch b
                         ON dt.decision_tree_id = b.decision_tree_id
                             AND b.feature_vector_id = fv.feature_vector_id
    </createView>
  </changeSet>

  <changeSet id="serp-governance-3.6.0-3" author="iwnek">
    <comment>
      Create governance_bulk_branch_change and governance_bulk_branch_change_reasoning_branch_ids
      tables.
    </comment>

    <createTable tableName="governance_bulk_branch_change">
      <column name="id" type="BIGINT" autoIncrement="true">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="bulk_branch_change_id" type="${uuid.type}">
        <constraints nullable="false" unique="true"/>
      </column>
      <column name="state" type="VARCHAR(16)">
        <constraints nullable="false"/>
      </column>
      <column name="enablement_change" type="BOOLEAN"/>
      <column name="solution_change" type="VARCHAR(100)"/>
      <column name="completed_at" type="TIMESTAMP"/>
      <column name="created_at" type="TIMESTAMP">
        <constraints nullable="false"/>
      </column>
      <column name="updated_at" type="TIMESTAMP"/>
      <column name="version" type="INTEGER">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <createTable tableName="governance_bulk_branch_change_reasoning_branch_ids">
      <column name="id" type="BIGINT">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="decision_tree_id" type="BIGINT">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="feature_vector_id" type="BIGINT">
        <constraints primaryKey="true" nullable="false"/>
      </column>
    </createTable>

    <addForeignKeyConstraint
        baseTableName="governance_bulk_branch_change_reasoning_branch_ids"
        baseColumnNames="id"
        constraintName="governance_bulk_branch_change_reasoning_branch_ids_id"
        referencedTableName="governance_bulk_branch_change"
        referencedColumnNames="id"/>

    <addForeignKeyConstraint
        baseTableName="governance_bulk_branch_change_reasoning_branch_ids"
        baseColumnNames="decision_tree_id"
        constraintName="fk_bulk_branch_change_reasoning_branch_ids_decision_tree_id"
        referencedTableName="governance_decision_tree"
        referencedColumnNames="decision_tree_id"
        onUpdate="CASCADE"
        onDelete="NO ACTION"
        deferrable="true"
        initiallyDeferred="true"/>

    <addForeignKeyConstraint
        baseTableName="governance_bulk_branch_change_reasoning_branch_ids"
        baseColumnNames="feature_vector_id"
        constraintName="fk_bulk_branch_change_reasoning_branch_ids_feature_vector_id"
        referencedTableName="governance_feature_vector"
        referencedColumnNames="feature_vector_id"
        onUpdate="CASCADE"
        onDelete="NO ACTION"
        deferrable="true"
        initiallyDeferred="true"/>
  </changeSet>

  <changeSet id="serp-governance-3.6.0-4" author="ajaromin">
    <createIndex
        tableName="governance_bulk_branch_change"
        indexName="ix_governance_bulk_branch_change_state">
      <column name="state"/>
    </createIndex>
  </changeSet>

  <changeSet id="serp-governance-3.6.0-5" author="ajaromin">
    <comment>
      Modify the view `governance_vector_solution_query` to not display disabled branches.
    </comment>

    <dropView viewName="governance_vector_solution_query"/>

    <!--@formatter:off-->
    <createView viewName="governance_vector_solution_query">
      SELECT b.decision_tree_id   as decision_tree_id
      , fv.feature_vector_id as feature_vector_id
      , dg.name              as decision_group
      , b.solution           as solution
      , fv.vector_signature  as vector_signature
      FROM governance_branch b
      JOIN governance_feature_vector fv ON b.feature_vector_id = fv.feature_vector_id
      JOIN governance_activation a ON b.decision_tree_id = a.decision_tree_id
      JOIN governance_decision_group dg ON a.decision_group_id = dg.decision_group_id
      WHERE b.enabled = true
    </createView>
    <!--@formatter:on-->
  </changeSet>

  <changeSet id="serp-governance-3.6.0-6" author="mkoziol">
    <comment>
      Modify data in the `governance_branch` to contain a "BRANCH_" prefix in the solution column
    </comment>

    <sql splitStatements="true" endDelimiter=";" stripComments="true">
      UPDATE governance_branch SET solution = 'BRANCH_' || solution
      WHERE solution NOT LIKE 'BRANCH_%';
    </sql>
  </changeSet>
</databaseChangeLog>
