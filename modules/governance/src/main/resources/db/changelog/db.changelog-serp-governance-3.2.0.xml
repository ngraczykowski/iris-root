<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

  <changeSet id="serp-governance-3.2.0-1" author="iwnek">
    <!--@formatter:off-->
    <createView viewName="governance_reasoning_branch_features_query">
      SELECT gfv.feature_vector_id AS reasoning_branch_id
           , gfs.features          AS features
      FROM governance_feature_vector gfv
           LEFT JOIN governance_feature_set gfs
                ON gfv.features_signature = gfs.features_signature
    </createView>
    <!--@formatter:on-->
  </changeSet>

  <changeSet id="serp-governance-3.2.0-2" author="iwnek">
    <comment>
      Rename `reasoning_branch_id` to `feature_vector_id` in all governance views.
      Add `created_at` to `governance_reasoning_branch_query`.
    </comment>

    <dropView viewName="governance_reasoning_branch_query"/>
    <dropView viewName="governance_reasoning_branch_features_query"/>
    <dropView viewName="governance_vector_solution_query"/>

    <!-- @formatter:off -->
    <createView viewName="governance_reasoning_branch_query">
      SELECT dt.decision_tree_id  as decision_tree_id
      , fv.feature_vector_id as feature_vector_id
      , b.solution           as solution
      , b.enabled            as enabled
      , fv.values            as values
      , b.created_at         as created_at
      , b.last_used_at       as last_used_at
      FROM governance_decision_tree dt
      LEFT JOIN governance_branch b ON dt.decision_tree_id = b.decision_tree_id
      JOIN governance_feature_vector fv ON fv.feature_vector_id = b.feature_vector_id
    </createView>
    <!-- @formatter:on -->

    <!--@formatter:off-->
    <createView viewName="governance_reasoning_branch_features_query">
      SELECT gfv.feature_vector_id AS feature_vector_id
      , gfs.features          AS features
      FROM governance_feature_vector gfv
      LEFT JOIN governance_feature_set gfs
      ON gfv.features_signature = gfs.features_signature
    </createView>
    <!--@formatter:on-->

    <!--@formatter:off-->
    <createView viewName="governance_vector_solution_query">
      SELECT b.decision_tree_id   as decision_tree_id
      , fv.feature_vector_id as feature_vector_id
      , dg.name              as decision_group
      , b.solution           as solution
      , fv.vector_signature  as vector_signature
      FROM governance_branch b
      JOIN governance_feature_vector fv ON b.feature_vector_id = fv.feature_vector_id
      JOIN governance_activation a ON b.decision_tree_id = a.decision_tree_id
      JOIN governance_decision_group dg ON a.decision_group_id = dg.decision_group_id
    </createView>
    <!--@formatter:on-->
  </changeSet>
</databaseChangeLog>
