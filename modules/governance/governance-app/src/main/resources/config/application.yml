####################################################################################################
# Solution Discrepancy AMQP Configuration
####################################################################################################
serp:
  notifier:
    integration:
      inbound-queue-name: notifier.incoming-event
      outbound-exchange-name:
      outbound-routing-key: notifier.send-mail
      mail:
        inbound-queue-name: notifier.send-mail
  governance:
    agent:
      agentConfigurationSource: classpath:agent_configs.json
      agentDetailsSource: classpath:agent_details.json
    integration:
      solution-discrepancy:
        inbound-queue-name: governance.solution-discrepancy
        outbound-exchange-name: notification
        reasoning-branches-disabled-routing-key: notification.reasoning-branches-disabled
    model:
      categorySource: classpath:categories.json

  ####################################################################################################
# Error Queue Configuration
####################################################################################################
  messaging:
    error-queue:
      enabled: true
####################################################################################################
# Defaults (overridden by environment variables or arguments)
####################################################################################################

#---------------------------------------------------------------------------------------------------
# SERVER
#---------------------------------------------------------------------------------------------------
serp.web.threads.io: 4
serp.web.threads.worker: 16
serp.server.protocol: http

#---------------------------------------------------------------------------------------------------
# GENERAL
#---------------------------------------------------------------------------------------------------
serp.execution.threads: 8
serp.execution.threads.max: 16
serp.execution.queue: 10000

serp.scheduling.threads: 2

# XXX(ahaczewski): Temporarily set to true, until we're sure customer correctly configured SERP.
serp.show-env: true

#---------------------------------------------------------------------------------------------------
# SERVICE DISCOVERY
#---------------------------------------------------------------------------------------------------
serp.consul.discovery.enabled: ${serp.consul.enabled}

#---------------------------------------------------------------------------------------------------
# mTLS - enabled by default
#---------------------------------------------------------------------------------------------------
serp.tls.enabled: false
serp.consul.traefik.passTLSCert: ${serp.tls.enabled}
serp.consul.traefik.entryPoints: unprotectedGateway

####################################################################################################
# CONFIGURATION
####################################################################################################

#---------------------------------------------------------------------------------------------------
# SERVER
#---------------------------------------------------------------------------------------------------
# Embedded server configuration
server:
  port: 24204
  forward-headers-strategy: native
  undertow:
    io-threads: ${serp.web.threads.io}
    worker-threads: ${serp.web.threads.worker}

  servlet:
    context-path: /rest/${spring.application.name}

  error:
    include-exception: true
    include-stacktrace: never

#---------------------------------------------------------------------------------------------------
# MANAGEMENT
#---------------------------------------------------------------------------------------------------

# Management HTTP server
management:
  health:
    mail:
      enabled: false
  endpoint:
    health.show-details: always

  endpoints:
    web:
      base-path: /management
      exposure:
        include: ["health", "info", "liquibase", "metrics", "prometheus", "loggers"]
    # loggers endpoint is secured with mTLS
    loggers:
      sensitive: false

  metrics:
    tags:
      application: ${spring.application.name}

#---------------------------------------------------------------------------------------------------
# GENERAL
#---------------------------------------------------------------------------------------------------
spring:
  application:
    name: governance
  # AOP configuration - disabled due to AspectJ compile-time weaving use
  aop:
    auto: false

  # Task execution and scheduling
  task:
    execution:
      pool:
        core-size: ${serp.execution.threads}
        max-size: ${serp.execution.threads.max}
        queue-capacity: ${serp.execution.queue}
        keep-alive: 10s
      thread-name-prefix: pool-task-

    scheduling:
      pool.size: ${serp.scheduling.threads}
      thread-name-prefix: pool-scheduling-

  main:
    banner-mode: 'off'

  groovy:
    template:
      check-template-location: false

  cloud:
    service-registry:
      enabled: ${serp.consul.enabled}
      auto-registration:
        enabled: ${serp.consul.enabled}

  servlet:
    multipart.max-file-size: 10MB
    multipart.max-request-size: 10MB

grpc:
  server:
    port: 24205
  client:
    GLOBAL:
      enableKeepAlive: true
      negotiationType: PLAINTEXT

    governance:
      address: static://localhost:24205

    reco:
      address: static://localhost:24207

    pipeline:
      address: static://localhost:24203

    gateway:
      address: static://localhost:24201

    name-agent:
      address: static://localhost:24301

    document-number-agent:
      address: static://localhost:24309

    document-comparer-agent:
      address: static://localhost:24307

    gender-agent:
      address: static://localhost:24311

    country-agent:
      address: static://localhost:24315

    date-agent:
      address: static://localhost:24313


serp.governance:
  cors:
    allowed-origins: "*"
    allowed-methods: "*"
    allowed-headers: "*"
    exposed-headers: "Authorization,Link,X-Total-Count"
    allow-credentials: true
    max-age: 1800

  policy-step-solution:
    hinted-enabled: false

sep.auth:
  permissionMethodsMappings:
    CANCEL_CHANGE_REQUESTS:
      - "CANCEL_CHANGE_REQUEST"
    APPROVE_CHANGE_REQUESTS:
      - "APPROVE_CHANGE_REQUEST"
    CREATE_CHANGE_REQUESTS:
      - "CREATE_CHANGE_REQUEST"
    REJECT_CHANGE_REQUESTS:
      - "REJECT_CHANGE_REQUEST"
    VIEW_CHANGE_REQUESTS:
      - "GET_CHANGE_REQUEST"
      - "LIST_CHANGE_REQUESTS"
    VIEW_POLICIES:
      - "LIST_POLICIES"
      - "LIST_STEPS_LOGIC"
      - "LIST_STEPS_ORDER"
      - "LIST_STEPS"
      - "LIST_STEP_FEATURE_VECTORS"
      - "LIST_AGENTS"
      - "LIST_CATEGORIES"
      - "LIST_STEP_FEATURE_VECTORS"
    IMPORT_POLICY:
      - "IMPORT_POLICY"
    MANAGE_MODEL:
      - "CREATE_MODEL"
      - "EXPORT_MODEL"
      - "LIST_MODELS"
    MANAGE_POLICY:
      - "EDIT_POLICY"
      - "CLONE_POLICY"
      - "CREATE_POLICY"
      - "DELETE_POLICY"
    MANAGE_STEPS:
      - "EDIT_STEPS_LOGIC"
      - "CREATE_STEP"
      - "EDIT_STEP"
      - "REMOVE_STEP"
    MANAGE_QA_ALERTS:
      - "ALERTS_ANALYSIS"
      - "ALERTS_VALIDATION"
      - "VIEW_VECTORS_STATISTICS"
    VIEW_VECTORS:
      - "LIST_VECTORS"

  rolePermissionsMappings:
#    POLICY_MANAGER:
    APPROVER:
      - "APPROVE_CHANGE_REQUESTS"
      - "REJECT_CHANGE_REQUESTS"
      - "VIEW_CHANGE_REQUESTS"
    BUSINESS_OPERATOR:
      - "CANCEL_CHANGE_REQUESTS"
      - "CREATE_CHANGE_REQUESTS"
      - "VIEW_CHANGE_REQUESTS"
      - "VIEW_POLICIES"
      - "IMPORT_POLICY"
      - "MANAGE_MODEL"
      - "MANAGE_POLICY"
      - "MANAGE_STEPS"
      - "MANAGE_QA_ALERTS"
      - "VIEW_VECTORS"

serp.governance.qa:
  scheduled:
    viewing-decision:
      max-ms: 45000