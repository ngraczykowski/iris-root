<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

  <changeSet id="simulator-1.0.0-1" author="anowicki">
    <createTable tableName="simulator_simulation">
      <column name="id" type="BIGINT" autoIncrement="true">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="simulation_id" type="${type.uuid}">
        <constraints nullable="false"/>
      </column>
      <column name="name" type="TEXT">
        <constraints nullable="false"/>
      </column>
      <column name="description" type="TEXT"/>
      <column name="policy_id" type="${type.uuid}">
        <constraints nullable="false"/>
      </column>
      <column name="state" type="VARCHAR(24)">
        <constraints nullable="false"/>
      </column>
      <column name="created_by" type="VARCHAR(64)">
        <constraints nullable="false"/>
      </column>
      <column name="created_at" type="TIMESTAMP">
        <constraints nullable="false"/>
      </column>
      <column name="started_at" type="TIMESTAMP"/>
      <column name="finished_at" type="TIMESTAMP"/>
    </createTable>

    <createIndex
        tableName="simulator_simulation"
        indexName="ix_simulator_simulation_id"
        unique="true">
      <column name="simulation_id"/>
    </createIndex>

    <createTable tableName="simulator_simulation_dataset_id">
      <column name="simulation_id" type="${type.uuid}">
        <constraints nullable="false"/>
      </column>
      <column name="dataset_id" type="${type.uuid}">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <addForeignKeyConstraint
        baseTableName="simulator_simulation_dataset_id"
        baseColumnNames="simulation_id"
        constraintName="fk_simulator_simulation_simulation_id"
        referencedTableName="simulator_simulation"
        referencedColumnNames="simulation_id"
        onDelete="CASCADE"
        onUpdate="CASCADE"
        deferrable="true"
        initiallyDeferred="true"/>

  </changeSet>

  <changeSet id="simulator-1.0.0-2" author="anowicki">
    <createTable tableName="simulator_dataset">
      <column name="id" type="BIGINT" autoIncrement="true">
        <constraints primaryKey="true" nullable="false"/>
      </column>
      <column name="dataset_id" type="${type.uuid}">
        <constraints nullable="false"/>
      </column>
      <column name="resource_name" type="VARCHAR(256)">
        <constraints nullable="false"/>
      </column>
      <column name="created_by" type="VARCHAR(64)">
        <constraints nullable="false"/>
      </column>
      <column name="created_at" type="TIMESTAMP">
        <constraints nullable="false"/>
      </column>
      <column name="name" type="TEXT">
        <constraints nullable="false"/>
      </column>
      <column name="description" type="TEXT"/>
      <column name="generation_date_from" type="TIMESTAMP"/>
      <column name="generation_date_to" type="TIMESTAMP"/>
      <column name="initial_alert_count" type="BIGINT">
        <constraints nullable="false"/>
      </column>
    </createTable>

    <createIndex
        tableName="simulator_dataset"
        indexName="ix_simulator_dataset_dataset_id"
        unique="true">
      <column name="dataset_id"/>
    </createIndex>
  </changeSet>

  <changeSet id="simulator-1.0.0-3" author="mmastylo">
    <addColumn tableName="simulator_simulation">
      <column name="analysis_name" type="VARCHAR(256)">
        <constraints nullable="false"/>
      </column>
    </addColumn>
  </changeSet>

  <changeSet id="simulator-1.0.0-4" author="mmastylo">
    <renameColumn
        tableName="simulator_simulation"
        oldColumnName="policy_id"
        newColumnName="model_id"/>
  </changeSet>

  <changeSet id="simulator-1.0.0-5" author="mmastylo">
    <renameColumn
        tableName="simulator_simulation"
        oldColumnName="model_id"
        newColumnName="model_name"/>

    <modifyDataType
        tableName="simulator_simulation"
        columnName="model_name"
        newDataType="VARCHAR(256)"/>

    <renameTable
        oldTableName="simulator_simulation_dataset_id"
        newTableName="simulator_simulation_dataset_name"/>

    <renameColumn
        tableName="simulator_simulation_dataset_name"
        oldColumnName="dataset_id"
        newColumnName="dataset_name"/>

    <modifyDataType
        tableName="simulator_simulation_dataset_name"
        columnName="dataset_name"
        newDataType="VARCHAR(256)"/>
  </changeSet>

</databaseChangeLog>
