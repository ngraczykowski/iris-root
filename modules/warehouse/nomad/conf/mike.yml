server:
  port: { { env "NOMAD_PORT_http" } }

management:
  health:
    elasticsearch:
      enabled: false

spring:
  rabbitmq:
    addresses: { { range $index, $rabbit := service "amqp.rabbitmq" - } }
      { { if $index } },{ { end - } }
      { { $rabbit.Address } }:{{ $rabbit.Port -}}
  {{- end }}
# NOTE(ahaczewski): Intentionally left empty.
    host:
    virtual-host: /{{ env "NOMAD_NAMESPACE" }}
  cloud:
    consul:
      enabled: true
      host: localhost
      port: 8500
      scheme: http
      discovery:
        enabled: true
        register: false
        register-health-check: false
        catalog-services-watch:
          enabled: true
      service-registry:
        auto-registration:
          enabled: false

warehouse:
  migration:
    enabled: false
  alert-level-security:
    enabled: false
  persistence:
    alert:
      recommendation-date-field: "recommendationDate"

  db:
    name: { { env "NOMAD_NAMESPACE" } }-warehouse
  {{- $nomad_namespace := env "NOMAD_NAMESPACE" -}}
  {{- with service (print $nomad_namespace "-warehouse-db") }}
    host: { { (index . 0).Address } }
    port: { { (index . 0).Port } }
  { { end - } }

  minio:
    url: https://minio.silenteight.com
  retention:
    alert:
      batch-size: 1000

  sampling:
    filters:
      - name: alert_s8_recommendation
        values: ACTION_FALSE_POSITIVE
  task:
    async:
      execution:
        pool:
          core-size: 4
          max-size: 16
          queue-capacity: 50
          thread-name-prefix: async-auth-aware-

keycloak:
  client-id: { { env "NOMAD_NAMESPACE" } }-frontend
  adapter:
    auth-server-url: https://auth.silenteight.com
    realm: sens-webapp
    public-client: false
    confidential-port: 0
    principal-attribute: preferred_username
    ssl-required: external

grpc:
  logging:
    enabled: true
  server:
    port: { { env "NOMAD_PORT_grpc" } }

warehouse.report.statistics:
  all-alerts-query:
    SELECT count(*)
    FROM warehouse_simulation_alert
    WHERE analysis_name = ?
  solved-alerts-query:
    SELECT count(*)
    FROM warehouse_simulation_alert
    WHERE analysis_name = ?
    AND (payload ->> 'recommendationRecommendedAction')
    IN ('ACTION_FALSE_POSITIVE', 'ACTION_POTENTIAL_TRUE_POSITIVE')
  ai-false-positive-query:
    SELECT count(*)
    FROM warehouse_simulation_alert wsa
    JOIN warehouse_alert wa ON wsa.name = wa.name
    WHERE wsa.analysis_name = ?
    AND (wa.payload ->> 'analystDecision') IN ('ANALYST_FALSE_POSITIVE', 'ANALYST_TRUE_POSITIVE')
    AND (wsa.payload ->> 'recommendationRecommendedAction') = 'ACTION_FALSE_POSITIVE'
  analyst-false-positive-query:
    SELECT count(*)
    FROM warehouse_simulation_alert wsa
    JOIN warehouse_alert wa ON wsa.name = wa.name
    WHERE wsa.analysis_name = ?
    AND (wa.payload ->> 'analystDecision') = 'ANALYST_FALSE_POSITIVE'
    AND (wsa.payload ->> 'recommendationRecommendedAction') = 'ACTION_FALSE_POSITIVE'

warehouse.report.zip:
  enabled: true
  rowsLimit: 10

warehouse.reports.v2:
  reports:
    - name: RB_SCORER_MATCH_LEVEL
      type: simulation
      description: RB Scorer
      selectSqlQuery: >

    - name: RB_SCORER_MATCH_LEVEL
      type: production
      description: RB Scorer (Match Level)
      selectSqlQuery: >

    - name: AI_REASONING
      type: production
      description: AI Reasoning (Alert Level)
      selectSqlQuery: >

    - name: AI_REASONING_MATCH_LEVEL
      type: production
      description: AI Reasoning (Match Level)
      selectSqlQuery: >

    - name: AI_REASONING_MATCH_LEVEL
      type: simulation
      description: AI Reasoning
      selectSqlQuery: >

    - name: ACCURACY_ALERT_LEVEL
      type: production
      description: Accuracy (Alert Level)
      selectSqlQuery: >

    - name: ACCURACY_MATCH_LEVEL
      type: production
      description: Accuracy (Match Level)
      selectSqlQuery: >

    - name: ACCURACY_MATCH_LEVEL
      type: simulation
      description: Accuracy
      selectSqlQuery: >

    - name: METRICS
      type: production
      description: Metrics (Alert Level)
      selectSqlQuery: >
        WITH main AS (
            SELECT payload ->> 's8Recommendation' recommendation,
                   payload ->> 'analystDecision'  analyst_decision,
                   payload ->> 'batchWatchList'   list_type,
                   recommendation_date            recommendation_date
            FROM warehouse_alert
            WHERE recommendation_date BETWEEN TIMESTAMP '${from}' AND TIMESTAMP '${to}'
            GROUP BY payload ->> 's8Recommendation',
                     payload ->> 'analystDecision',
                     payload ->> 'batchWatchList',
                     recommendation_date
        ),
             grouped AS (
                 SELECT TO_CHAR(main.recommendation_date, 'MM-YYYY')                      g_date,
                        main.list_type                                                    g_list_type,
                        COUNT(*)                                                          g_total,
                        COUNT(*)
                        FILTER ( WHERE recommendation = 'ACTION_POTENTIAL_TRUE_POSITIVE') g_total_true_positive,
                        COUNT(*)
                        FILTER ( WHERE recommendation = 'ACTION_FALSE_POSITIVE')          g_total_false_positive,
                        COUNT(*) FILTER ( WHERE recommendation = 'ACTION_POTENTIAL_TRUE_POSITIVE'
                            AND analyst_decision =
                                'analyst_decision_true_positive')                         g_total_ptp_and_a_passed,
                        COUNT(*) FILTER ( WHERE recommendation = 'ACTION_POTENTIAL_TRUE_POSITIVE'
                            AND analyst_decision IN ('analyst_decision_true_positive',
                                                     'analyst_decision_false_positive') ) g_total_ptp_and_a,
                        COUNT(*) FILTER ( WHERE recommendation = 'ACTION_FALSE_POSITIVE'
                            AND analyst_decision =
                                'analyst_decision_false_positive')                        g_total_fp_and_a_passed,
                        COUNT(*) FILTER ( WHERE recommendation = 'ACTION_FALSE_POSITIVE'
                            AND analyst_decision IN ('analyst_decision_true_positive',
                                                     'analyst_decision_false_positive'))  g_total_fp_and_a
                 FROM main
                 GROUP BY 1, 2
             )

        SELECT g_date                                                                                  AS "Date (MM-YYYY)",
               g_list_type                                                                             AS "Watchlist Type",
               (g_total_true_positive + g_total_false_positive)                                        AS "# of S8 Solved as FP or PTP",
               g_total                                                                                 AS "# of S8 Total Alerts Processed",
               ROUND(((g_total_true_positive::decimal + g_total_false_positive::decimal) /
                      GREATEST(g_total, 1)) * 100,
                     3)                                                                                AS "Efficiency [%]",
               g_total_fp_and_a_passed                                                                 AS "# of S8 Solved as FP and Analyst Solved as FP",
               (g_total_fp_and_a - g_total_fp_and_a_passed)                                            AS "# of S8 Solved as FP and Analyst Solved as TP",
               CASE
                   WHEN g_total_fp_and_a = 0 THEN 'n/a'
                   ELSE CAST(ROUND(
                               (g_total_fp_and_a_passed::decimal / GREATEST(g_total_fp_and_a::decimal, 1)) *
                               100,
                               3) AS varchar) END                                                      AS "FP Effectiveness [%]",
               g_total_ptp_and_a_passed                                                                AS "# of S8 Solved as PTP and Analyst Solved as TP",
               (g_total_ptp_and_a - g_total_ptp_and_a_passed)                                          AS "# of S8 Solved as PTP and Analyst Solved as FP",
               CASE
                   WHEN g_total_ptp_and_a = 0 THEN 'n/a'
                   ELSE CAST(ROUND((g_total_ptp_and_a_passed::decimal /
                                    GREATEST(g_total_ptp_and_a::decimal, 1)) * 100,
                                   3) AS varchar) END                                                  AS "PTP Effectiveness[%]"
        FROM grouped
        ORDER BY g_date 

    - name: METRICS_ALERT_LEVEL
      type: simulation
      description: Metrics
      selectSqlQuery: >
