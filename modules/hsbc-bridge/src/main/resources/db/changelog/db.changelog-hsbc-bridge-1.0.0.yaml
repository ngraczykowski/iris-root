databaseChangeLog:
  - changeSet:
      id: 1.0.0-1
      author: bmartofel
      changes:
        - createTable:
            tableName: hsbc_bridge_analysis
            columns:
              - column:
                  name: id
                  type: bigint
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: name
                  type: varchar(256)
              - column:
                  name: policy
                  type: varchar(100)
              - column:
                  name: strategy
                  type: varchar(100)
              - column:
                  name: timeout_at
                  type: timestamp
              - column:
                  name: alerts_count
                  type: bigint
                  constraints:
                    nullable: false
              - column:
                  name: dataset
                  type: varchar(100)
              - column:
                  name: status
                  type: varchar(30)
              - column:
                  name: created_at
                  type: timestamp
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: timestamp

        - createTable:
            tableName: hsbc_bridge_bulk
            columns:
              - column:
                  name: id
                  type: varchar(50)
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: created_at
                  type: timestamp
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: timestamp
              - column:
                  name: status
                  type: varchar(30)
              - column:
                  name: analysis_id
                  type: bigint
                  constraints:
                    nullable: true
                    foreignKeyName: fk_bulk_analysis_id
                    references: hsbc_bridge_analysis(id)
              - column:
                  name: error_message
                  type: text
              - column:
                  name: error_timestamp
                  type: timestamp
              - column:
                  name: learning
                  type: boolean
                  constraints:
                    nullable: false

  - changeSet:
      id: 1.0.0-2
      author: bmartofel
      changes:
        - createTable:
            tableName: hsbc_bridge_alert_payload
            columns:
              - column:
                  name: id
                  type: bigint
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: created_at
                  type: timestamp
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: timestamp
              - column:
                  name: payload
                  type: bytea

        - createTable:
            tableName: hsbc_bridge_alert
            columns:
              - column:
                  name: id
                  type: bigint
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: external_id
                  type: varchar(60)
              - column:
                  name: bulk_id
                  type: varchar(50)
                  constraints:
                    nullable: false
                    foreignKeyName: fk_alert_bulk_id
                    references: hsbc_bridge_bulk(id)
              - column:
                  name: discriminator
                  type: varchar(256)
              - column:
                  name: name
                  type: varchar(256)
              - column:
                  name: status
                  type: varchar(30)
              - column:
                  name: created_at
                  type: timestamp
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: timestamp
              - column:
                  name: error_message
                  type: text
              - column:
                  name: alert_payload_id
                  type: bigint
                  constraints:
                    nullable: false
                    foreignKeyName: fk_alert_payload_id
                    references: hsbc_bridge_alert_payload(id)

        - createTable:
            tableName: hsbc_bridge_match_payload
            columns:
              - column:
                  name: id
                  type: bigint
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: created_at
                  type: timestamp
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: timestamp
              - column:
                  name: payload
                  type: bytea

        - createTable:
            tableName: hsbc_bridge_match
            columns:
              - column:
                  name: id
                  type: bigint
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: external_id
                  type: varchar(60)
                  constraints:
                    nullable: false
              - column:
                  name: name
                  type: varchar(256)
              - column:
                  name: created_at
                  type: timestamp
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: timestamp
              - column:
                  name: alert_id
                  type: bigint
                  constraints:
                    nullable: false
                    foreignKeyName: fk_alert_id
                    references: hsbc_bridge_alert(id)
              - column:
                  name: match_payload_id
                  type: bigint
                  constraints:
                    nullable: false
                    foreignKeyName: fk_match_payload_id
                    references: hsbc_bridge_match_payload(id)

  - changeSet:
      id: 1.0.0-3
      author: bmartofel
      changes:
        - createTable:
            tableName: hsbc_bridge_category
            columns:
              - column:
                  name: id
                  type: bigint
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: name
                  type: varchar(50)
                  constraints:
                    nullable: false
              - column:
                  name: display_name
                  type: varchar(50)
                  constraints:
                    nullable: false
              - column:
                  name: type
                  type: varchar(50)
              - column:
                  name: multi_value
                  type: boolean
                  constraints:
                    nullable: false
              - column:
                  name: created_at
                  type: timestamp
                  constraints:
                    nullable: false
              - column:
                  name: updated_at
                  type: timestamp

  - changeSet:
      id: 1.0.0-4
      author: bmartofel
      changes:
        - createTable:
            tableName: hsbc_bridge_category_allowed_values
            columns:
              - column:
                  name: category_id
                  type: bigint
                  constraints:
                    nullable: false
                    foreignKeyName: fk_category_id
                    references: hsbc_bridge_category(id)
              - column:
                  name: value
                  type: varchar(50)
                  constraints:
                    nullable: false

  - changeSet:
      id: 1.0.0-5
      author: bmartofel
      changes:
        - createTable:
            tableName: hsbc_bridge_match_category
            columns:
              - column:
                  name: id
                  type: bigint
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: match_id
                  type: bigint
                  constraints:
                    nullable: false
                    foreignKeyName: fk_category_match_match_id
                    references: hsbc_bridge_match(id)
              - column:
                  name: category_id
                  type: bigint
                  constraints:
                    nullable: false
                    foreignKeyName: fk_category_match_category_id
                    references: hsbc_bridge_category(id)
        - createTable:
            tableName: hsbc_bridge_match_category_values
            columns:
              - column:
                  name: match_category_id
                  type: bigint
                  constraints:
                    nullable: false
                    foreignKeyName: fk_match_category_cid
                    references: hsbc_bridge_match_category(id)
              - column:
                  name: value
                  type: varchar(100)
                  constraints:
                    nullable: false

  - changeSet:
      id: 1.0.0-6
      author: bmartofel
      changes:
        - createTable:
            tableName: hsbc_bridge_recommendation
            columns:
              - column:
                  name: id
                  type: bigint
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: alert
                  type: varchar(255)
                  constraints:
                    nullable: false
              - column:
                  name: recommended_action
                  type: varchar(255)
                  constraints:
                    nullable: false
              - column:
                  name: recommendation_comment
                  type: text
                  constraints:
                    nullable: false
              - column:
                  name: recommended_at
                  type: timestamp
                  constraints:
                    nullable: false
              - column:
                  name: name
                  type: varchar(255)
                  constraints:
                    nullable: false

  - changeSet:
      id: 1.0.0-7
      author: bmartofel
      changes:
        - sql: create or replace view hsbc_bridge_match_category_view(id, multi_value, name) as SELECT mc.id,c.multi_value, (('categories/'::text || c.name::text) || '/'::text) || m.name::text AS name FROM hsbc_bridge_match_category mc, hsbc_bridge_match m, hsbc_bridge_category c WHERE mc.match_id = m.id AND mc.category_id = c.id;

  - changeSet:
      id: 1.0.0-8
      author: bmartofel
      changes:
        - createIndex:
            clustered: true
            columns:
              - column:
                  name: bulk_id
            indexName: idx_bridge_alert_bulk_id
            tableName: hsbc_bridge_alert
        - createIndex:
            clustered: true
            columns:
              - column:
                  name: name
            indexName: idx_bridge_alert_name
            tableName: hsbc_bridge_alert

  - changeSet:
      id: 1.0.0-9
      author: awojcicki
      changes:
        - createTable:
            tableName: hsbc_bridge_model
            columns:
              - column:
                  name: id
                  type: bigint
                  autoIncrement: true
                  constraints:
                    primaryKey: true
                    nullable: false
              - column:
                  name: name
                  type: varchar(255)
                  constraints:
                    nullable: false
              - column:
                  name: minio_url
                  type: varchar(255)
                  constraints:
                    nullable: false
              - column:
                  name: type
                  type: varchar(30)


  - changeSet:
      id: 1.0.0-10
      author: bmartofel
      changes:
        - createTable:
            tableName: hsbc_bridge_alert_metadata
            columns:
              - column:
                  name: id
                  type: bigint
              - column:
                  name: key
                  type: varchar(255)
                  constraints:
                    nullable: false
              - column:
                  name: value
                  type: text
        - createIndex:
            clustered: true
            columns:
              - column:
                  name: id
            indexName: idx_bridge_alert_metadata_id
            tableName: hsbc_bridge_alert_metadata

  - changeSet:
      id: 1.0.0-11
      author: mmrowka
      changes:
        - sql: create or replace view hsbc_bridge_match_category_view(id, multi_value, name) as SELECT mc.id,c.multi_value, ((c.name::text) || '/'::text) || m.name::text AS name FROM hsbc_bridge_match_category mc, hsbc_bridge_match m, hsbc_bridge_category c WHERE mc.match_id = m.id AND mc.category_id = c.id;
