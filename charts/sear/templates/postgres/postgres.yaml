apiVersion: acid.zalan.do/v1
kind: postgresql
metadata:
  name: {{ include "sear.fullname" . }}-postgres
  labels:
    app.kubernetes.io/component: database
    {{- include "sear.labels" . | nindent 4 }}
spec:
  teamId: {{ .Release.Name | quote }}

  postgresql:
    version: {{ .Values.database.postgresql.version | quote }}

  numberOfInstances: {{ .Values.database.numberOfInstances }}

  volume:
      size: {{ .Values.database.volume.size | quote }}

  # <user> : <roles>
  # waring: username is used in sear.postgresqlSecretName
  users:
    {{- if .Values.keycloak.internal }}
    keycloak: []
    {{- end }}
    {{- range $componentName, $component := include "sear.mergedComponents" . | mustFromJson }}
    {{- if and $component.enabled $component.db.enabled (not $component.db.external) }}
    {{ $component.db.name }}: []
    {{- end }}
    {{- end }}

  # <db>: <user>
  databases:
    {{- if .Values.keycloak.internal }}
    keycloak: keycloak
    {{- end }}
    {{- range $componentName, $component := include "sear.mergedComponents" . | mustFromJson }}
    {{- if and $component.enabled $component.db.enabled (not $component.db.external) }}
    {{ $component.db.name }}: {{ $component.db.name }}
    {{- end }}
    {{- end }}
