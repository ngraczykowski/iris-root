apiVersion: acid.zalan.do/v1
kind: postgresql
metadata:
  name: {{ include "sear.fullname" . }}-postgres
  labels:
    app.kubernetes.io/component: database
    {{- include "sear.labels" . | nindent 4 }}
spec:
  teamId: {{ .Release.Name | quote }}

  postgresql:
    version: {{ .Values.database.postgresql.version | quote }}

  numberOfInstances: {{ .Values.database.numberOfInstances }}

  volume:
      size: {{ .Values.database.volume.size | quote }}

  users:
    {{- range $componentName, $component := .Values.components }}
    {{- if and (hasKey $component "enabled" | ternary $component.enabled true) (hasKey $component "useDb" | ternary $component.useDb true) }}
    {{ default $componentName $component.dbName }}: []
    {{- end }}
    {{- end }}

  databases:
    {{- range $componentName, $component := .Values.components }}
    {{- if and (hasKey $component "enabled" | ternary $component.enabled true) (hasKey $component "useDb" | ternary $component.useDb true) }}
    {{ default $componentName $component.dbName }}: {{ default $componentName $component.dbName }}
    {{- end }}
    {{- end }}
