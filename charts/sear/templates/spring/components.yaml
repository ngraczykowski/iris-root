{{- range $componentName, $component := .Values.components -}}

{{- if (hasKey $component "enabled" | ternary $component.enabled true ) -}}

{{- $image := deepCopy $component.image | mergeOverwrite $.Values.common.image -}}
{{- $dbName := default $componentName $component.dbName -}}
{{- $webPath := default $componentName $component.webPath -}}
{{- $replicaCount := default $.Values.common.replicaCount $component.replicaCount -}}
{{- $args := concat $.Values.common.args (default (list) $component.args) -}}
{{- $configFiles := deepCopy (default (dict) $component.configFiles) | mergeOverwrite $.Values.common.configFiles -}}
{{- $service := default $.Values.common.service $component.service -}}
{{- $ingress := default $.Values.common.ingress $component.ingress -}}
{{- $resources := deepCopy (default (dict) $component.resources) | mergeOverwrite $.Values.common.resources -}}
{{- $containerPorts := deepCopy (default (dict) $component.containerPorts) | mergeOverwrite $.Values.common.containerPorts -}}
{{- $startupProbe := deepCopy (default (dict) $component.startupProbe) | mergeOverwrite $.Values.common.startupProbe -}}
{{- $livenessProbe := deepCopy (default (dict) $component.livenessProbe) | mergeOverwrite $.Values.common.livenessProbe -}}
{{- $readinessProbe := deepCopy (default (dict) $component.readinessProbe) | mergeOverwrite $.Values.common.readinessProbe -}}
{{- $autoscaling := deepCopy (default (dict) $component.autoscaling) | mergeOverwrite $.Values.common.autoscaling -}}
{{- $nodeSelector := deepCopy (default (dict) $component.nodeSelector) | mergeOverwrite $.Values.common.nodeSelector -}}
{{- $tolerations := concat $.Values.common.tolerations (default (list) $component.tolerations) -}}
{{- $affinity := deepCopy (default (dict) $component.affinity) | mergeOverwrite $.Values.common.affinity -}}

{{-
$mergedComponent := (dict
  "image" $image
  "replicaCount" $replicaCount
  "dbName" $dbName
  "webPath" $webPath
  "args" $args
  "configFiles" $configFiles
  "service" $service
  "ingress" $ingress
  "resources" $resources
  "containerPorts" $containerPorts
  "startupProbe" $startupProbe
  "livenessProbe" $livenessProbe
  "readinessProbe" $readinessProbe
  "autoscaling" $autoscaling
  "nodeSelector" $nodeSelector
  "tolerations" $tolerations
  "affinity" $affinity)
-}}
{{- $context := deepCopy $ | merge (dict "componentName" $componentName "component" $mergedComponent) -}}

{{- range $path, $_ := $.Files.Glob  "component/spring/*.yaml.tpl" }}
# From: {{ $path }}
# Component: {{ $componentName }}
{{ tpl ($.Files.Get $path) $context }}
---
{{- end }}
{{- end }}
{{- end }}
